<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blog Post - Izuchukwu Foods</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Navbar -->
  <nav class="bg-green-700 text-white px-6 py-4 flex justify-between items-center shadow">
    <a href="index.html" class="text-xl font-bold">Izuchukwu Foods</a>
    <div class="space-x-6 text-sm font-medium">
      <a href="index.html" class="hover:underline">Home</a>
      <a href="products.html" class="hover:underline">Products</a>
      <a href="blog.html" class="hover:underline">Blog</a>
    </div>
  </nav>

  <!-- Banner -->
  <header class="h-56 bg-cover bg-center text-white flex items-center justify-center" style="background-image: url('images/flyer.jpg'); background-attachment: fixed;">
    <h1 class="text-3xl font-bold bg-black bg-opacity-50 p-4 rounded">Blog Post</h1>
  </header>

  <!-- Post Section -->
  <section class="max-w-3xl mx-auto p-6">
    <h2 id="post-title" class="text-2xl font-bold mb-2"></h2>
    <p id="post-date" class="text-sm text-gray-500 mb-4"></p>
    <div id="post-body" class="prose max-w-none text-gray-800"></div>

    <!-- Reactions -->
    <div class="flex gap-4 mt-6" id="reactions">
      <button data-type="like" class="reaction-btn">‚ù§Ô∏è <span id="like-count">0</span></button>
      <button data-type="laugh" class="reaction-btn">üòÇ <span id="laugh-count">0</span></button>
      <button data-type="fire" class="reaction-btn">üî• <span id="fire-count">0</span></button>
    </div>

    <!-- Comment Section -->
    <div class="mt-10">
      <h3 class="text-xl font-semibold mb-2">Comments</h3>
      <form id="comment-form" class="mb-4">
        <input id="commenter" type="text" placeholder="Your name" required class="w-full p-2 border rounded mb-2"/>
        <textarea id="comment" placeholder="Write a comment..." required class="w-full p-2 border rounded mb-2"></textarea>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Post Comment</button>
      </form>
      <div id="comments-list" class="space-y-4"></div>
    </div>
  </section>

  <footer class="bg-green-700 text-white text-center py-6">
    <p class="text-sm">&copy; 2025 Izuchukwu Foods</p>
  </footer>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAx0q_QGU35tLFP4MtUMQQUtw-WVNagpHk",
      authDomain: "izuchukwu-foods.firebaseapp.com",
      projectId: "izuchukwu-foods",
      storageBucket: "izuchukwu-foods.appspot.com",
      messagingSenderId: "811147638426",
      appId: "1:811147638426:web:f2403b6cf7e0b6f19b1123"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get("id");
    const isAdmin = true; // üîí CHANGE TO FALSE OR ADD AUTH LATER

    const postTitle = document.getElementById("post-title");
    const postBody = document.getElementById("post-body");
    const postDate = document.getElementById("post-date");
    const reactions = {
      like: document.getElementById("like-count"),
      laugh: document.getElementById("laugh-count"),
      fire: document.getElementById("fire-count")
    };

    const commentForm = document.getElementById("comment-form");
    const commenter = document.getElementById("commenter");
    const commentInput = document.getElementById("comment");
    const commentsList = document.getElementById("comments-list");

    async function loadPost() {
      const docRef = doc(db, "posts", postId);
      const postSnap = await getDoc(docRef);
      if (!postSnap.exists()) {
        postTitle.textContent = "Post not found.";
        return;
      }
      const post = postSnap.data();
      postTitle.textContent = post.title;
      postBody.innerHTML = post.content;
      postDate.textContent = new Date(post.timestamp).toLocaleString();

      // Set reactions
      reactions.like.textContent = post.reactions?.like || 0;
      reactions.laugh.textContent = post.reactions?.laugh || 0;
      reactions.fire.textContent = post.reactions?.fire || 0;
    }

    // Handle reaction
    document.querySelectorAll(".reaction-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const type = btn.getAttribute("data-type");
        const docRef = doc(db, "posts", postId);
        const snap = await getDoc(docRef);
        const post = snap.data();
        const newCount = (post.reactions?.[type] || 0) + 1;

        await updateDoc(docRef, {
          [`reactions.${type}`]: newCount
        });

        reactions[type].textContent = newCount;
      });
    });

    // Add comment
    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      await addDoc(collection(db, "comments"), {
        postId,
        name: commenter.value,
        content: commentInput.value,
        timestamp: Date.now()
      });
      commenter.value = "";
      commentInput.value = "";
      loadComments();
    });

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString();
    }

    // Load comments
    async function loadComments() {
      commentsList.innerHTML = "<p class='text-gray-500'>Loading comments...</p>";

      const q = query(collection(db, "comments"), where("postId", "==", postId));
      const snapshot = await getDocs(q);
      commentsList.innerHTML = "";

      snapshot.forEach(docSnap => {
        const comment = docSnap.data();
        const commentId = docSnap.id;

        const el = document.createElement("div");
        el.className = "bg-white border rounded p-3 relative";
        el.innerHTML = `
          <p class="text-gray-800 font-medium">${comment.name}</p>
          <p class="text-gray-700 mt-1">${comment.content}</p>
          <p class="text-xs text-gray-500 mt-1">${formatDate(comment.timestamp)}</p>
          ${isAdmin ? `<button data-id="${commentId}" class="delete-comment absolute top-2 right-2 text-xs text-red-600 hover:underline">üóëÔ∏è Delete</button>` : ""}
        `;
        commentsList.appendChild(el);
      });

      if (!commentsList.innerHTML) {
        commentsList.innerHTML = "<p class='text-gray-500'>No comments yet.</p>";
      }

      // Handle delete
      document.querySelectorAll(".delete-comment").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (confirm("Delete this comment?")) {
            await deleteDoc(doc(db, "comments", id));
            loadComments();
          }
        });
      });
    }

    loadPost();
    loadComments();
  </script>
</body>
</html>